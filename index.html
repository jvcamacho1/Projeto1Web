<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="mobile.css">
</head>
<body>
  <div class="topo-mobile">
    <div class="lateral-esquerda-mobile">
      <img src="imagens/seta-voltar-loja.svg" alt="Voltar">
      <span><b>Loja Virtual</b></span>
    </div>
    <div class="lateral-direita-mobile" id="Logar1">
      <img src="imagens/ic-login.svg" alt="Cliente">
      <div class="container">
      <span id="spanEmai2">Email</span>
      <span>Senha</span>
      </div>
      <div class="container">
      <input type="text" name="login" id="login">
      <input type="password" name="password" id="password">
      </div>
    <button id="ajaxButton" type="button">Login</button>
    </div>
    <hr></hr>
  </div>

  <div class="topo">
    <div class="container">
      <div class="texto-topo">
      <img src="imagens/ic-duvidas-interrogacao.svg" alt="Interrogacao">
      <span>Dúvidas Frequentes</span>
      <img src="imagens/ic-duvida-topo-seta.svg" alt="Ver duvidas">
    </div>
  </div>
  </div>

  <div class="container">
    <div class="lateral-esquerda flutuante">
      <img src="imagens/seta-voltar-loja.svg" alt="Voltar">
      <span class="lojaVirtual"><b>Loja Virtual</b></span>
    </div>
    <div class = "corpo flutuante">
      <img src="imagens/logo-megamamute.svg" alt="Logo"> 
    </div>

    <div class="lateral-direita flutuante" id="Logar2">
      <img src="imagens/ic-login.svg" alt="Cliente">
      <div class="container">
      <span id="spanEmail">Email</span>
      <span>Senha</span>
      </div>
      <div class="container">
      <input type="text" name="login" id="loginMobile">
      <input type="password" name="password" id="passwordMobile">
      </div>
    <button id="ajaxButton2" type="button">Login</button>
    </div>
  </div>

  <div class="livros">
    <div id = livros class="container-livros"></div>
  </div>
    
  <div class="fundo">
    <div class="container">
      <div class="texto-meio">
        <h1>ENCONTRE AQUI O LIVRO QUE VOCÊ PROCURA</h1>
        <p><b>Informe o nome do</b> livro que você procura:</p>
        <form>
        <label>Digite o título</label>
        <input type="text" name="Livro" class="formu" id="bookName">
        <input type="button" name="Livro" class="botao" value="ENCONTRAR" id="findBooks">
        </form>
      </div>
    </div>
  </div>
  <div class="footer"></div>
</body>
<script>
  (function() {
    var httpRequest;
    var infoBook = [];
    document.getElementById("ajaxButton").addEventListener('click', getElements);
    document.getElementById("ajaxButton2").addEventListener('click', getElements);
    document.getElementById('findBooks').addEventListener('click', getBooks)
    document.addEventListener('DOMContentLoaded', testFunction)

    function testFunction() {
       if(localStorage.getItem('token')){
        var element = document.getElementById('Logar1')
        element.remove()
        var element2 = document.getElementById('Logar2')
        element2.remove()
      }
    }

    function getElements() {
      var login = document.getElementById("login").value || document.getElementById("loginMobile").value
      var password = document.getElementById("password").value || document.getElementById("passwordMobile").value
      if ((login || password) == ' ' || (login.length || password.length)<3) {
        alert("Usuario ou senha inválido")
        document.getElementById("login").value = ""
        document.getElementById("password").value = ""
        document.getElementById("loginMobile").value = ""
        document.getElementById("passwordMobile").value = ""
      }else{
        makeRequest(login, password)
      }
    }
  
    function makeRequest(login, password) {
      httpRequest = new XMLHttpRequest();
  
      if (!httpRequest) {
        alert('Cannot create an XMLHTTP instance');
        return false;
      }
      httpRequest.onreadystatechange = alertContents;
      httpRequest.open('POST', 'https://reqres.in/api/login');
      httpRequest.setRequestHeader("Content-Type", "application/json");
      httpRequest.send(JSON.stringify({email:login, password: password}));
    }
  
    function alertContents() {
      if (httpRequest.readyState === XMLHttpRequest.DONE) {
        if (httpRequest.status === 200) {
          var response = JSON.parse(httpRequest.responseText)
          if(localStorage.getItem('token')){
            alert('Usuário já logado')
          } else {
            localStorage.setItem('token', response.token)
            testFunction()
          }
        } else {
          alert('Usuário não encontrado')
        }
      }
    }

    function getBooks() {
      httpRequest = new XMLHttpRequest();
      infoBook = []
      var bookName = document.getElementById('bookName').value
      if(localStorage.getItem('token')){
        bookname = bookName.replace(/\s/g, '+')
        if (!httpRequest) {
          alert('Cannot create an XMLHTTP instance');
          return false;
        }
        httpRequest.onreadystatechange = requestResponse;
        httpRequest.open('GET', `http://openlibrary.org/search.json?title=${bookName}`);
        httpRequest.send();
      }else{
        alert("faça login para procurar um livro")
        document.getElementById("bookName").value = ""
      }
    }

    function requestResponse() {
      if (httpRequest.readyState === XMLHttpRequest.DONE) {
        if (httpRequest.status === 200) {
          var response = JSON.parse(httpRequest.responseText)
          if(response.docs[0]){
            var bookId = response.docs[0].key.split('/')[2]
            getBookById(bookId)
          } else {
            alert("Livro não encontrado")
            document.getElementById("bookName").value = ""
          }
        } else {
          alert('Livro não encontrado')
          document.getElementById("bookName").value = ""
        }
      }
    }

    function getBookById(id) {
      if (!httpRequest) {
        alert('Cannot create an XMLHTTP instance');
        return false;
      }
      httpRequest.onreadystatechange = requestResponseId;
      httpRequest.open('GET', `http://openlibrary.org/works/${id}.json`);
      httpRequest.send();
    }

    function requestResponseId() {
      if (httpRequest.readyState === XMLHttpRequest.DONE) {
        if (httpRequest.status === 200) {
          var response = JSON.parse(httpRequest.responseText)
          infoBook = [...infoBook, response.title]
          infoBook = [...infoBook, response.description]
          getAuthor(response.authors[0].author.key)
        } else {
          alert('Livro não encontrado');
        }
      }
    }

    function getAuthor(id) {
      if (!httpRequest) {
        alert('Cannot create an XMLHTTP instance');
        return false;
      }
      httpRequest.onreadystatechange = requestResponseAuthor;
      httpRequest.open('GET', `http://openlibrary.org${id}.json`);
      httpRequest.send();
    }

    function requestResponseAuthor() {
      if (httpRequest.readyState === XMLHttpRequest.DONE) {
        if (httpRequest.status === 200) {
          var response = JSON.parse(httpRequest.responseText)
          infoBook = [...infoBook, response.name]
          var list = document.getElementById('livros');
          console.log(infoBook)
          var entry1 = document.createElement('h2')
          var entry2 = document.createElement('h3')
          var entry3 = document.createElement('h4')
          entry1.appendChild(document.createTextNode("Título: "))
          entry1.appendChild(document.createTextNode(infoBook[0]))
          list.appendChild(entry1)
          entry2.appendChild(document.createTextNode("Descrição: "))
          entry2.appendChild(document.createTextNode(infoBook[1]))
          list.appendChild(entry2)
          entry3.appendChild(document.createTextNode("Autor: "))
          entry3.appendChild(document.createTextNode(infoBook[2]))
          list.appendChild(entry3)
        } else {
          alert('Livro não encontrado');
        }
      }
    }
  })();
  </script>
</html>